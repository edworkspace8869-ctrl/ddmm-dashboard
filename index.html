<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Parliament</title>
<meta name="theme-color" content="#0c0c10"/>
<link rel="manifest" href="manifest.json"/>
<style>
  /* System font stacks â€” zero network dependency, works fully offline */
</style>
<style>
/* â”€â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --ink:#0c0c10;
  --paper:#f5f2eb;
  --paper2:#ede9e0;
  --paper3:#e4dfd3;
  --gold:#b8913a;
  --gold-light:#d4a84b;
  --gold-pale:rgba(184,145,58,.12);
  --red:#c0392b;
  --red-pale:rgba(192,57,43,.1);
  --green:#1e7a4a;
  --green-pale:rgba(30,122,74,.1);
  --ink-dim:#5c5a54;
  --ink-mid:#8c8980;
  --border:#d4cfc4;
  --border-dark:#b8b2a4;
  --serif:'Iowan Old Style','Palatino Linotype','Book Antiqua',Palatino,'Georgia',serif;
  --mono:'ui-monospace','Cascadia Code','Fira Mono','Menlo','Consolas','Liberation Mono',monospace;
  --r:8px; --r-sm:5px;
  --shadow:0 2px 12px rgba(0,0,0,.08);
  --shadow-lg:0 8px 32px rgba(0,0,0,.14);
}
html{font-size:16px;scroll-behavior:smooth;}
body{background:var(--paper);color:var(--ink);font-family:var(--mono);font-size:.88rem;font-weight:400;min-height:100vh;display:flex;flex-direction:column;}
h1,h2,h3{font-family:var(--serif);letter-spacing:-.02em;font-weight:700;}
input,textarea,select,button{font-family:var(--mono);}
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:var(--paper2);}
::-webkit-scrollbar-thumb{background:var(--border-dark);border-radius:3px;}

/* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header{
  background:var(--ink);
  color:var(--paper);
  padding:.9rem 2rem;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:3px solid var(--gold);
  position:sticky;top:0;z-index:100;
}
.logo{display:flex;align-items:baseline;gap:.65rem;}
.logo h1{font-size:1.2rem;color:var(--paper);letter-spacing:.02em;}
.logo-sep{width:1px;height:14px;background:rgba(255,255,255,.2);align-self:center;}
.logo-sub{font-size:.6rem;letter-spacing:.14em;text-transform:uppercase;color:rgba(255,255,255,.4);}
.pwa-hint{font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.3);}

/* â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs{
  background:var(--ink);
  display:flex;
  border-bottom:1px solid rgba(255,255,255,.08);
  padding:0 2rem;
}
.tab-btn{
  font-family:var(--mono);font-size:.62rem;letter-spacing:.12em;text-transform:uppercase;
  background:none;border:none;color:rgba(255,255,255,.35);
  padding:.65rem 1rem .6rem;cursor:pointer;
  border-bottom:2px solid transparent;margin-bottom:-1px;
  transition:all .18s;
}
.tab-btn:hover{color:rgba(255,255,255,.7);}
.tab-btn.active{color:var(--gold-light);border-bottom-color:var(--gold);}

/* â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main{flex:1;padding:2rem;max-width:780px;margin:0 auto;width:100%;}
.view{display:none;}
.view.active{display:block;animation:rise .22s ease;}
@keyframes rise{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:none;}}

/* â”€â”€â”€ Typography helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.eyebrow{font-size:.58rem;letter-spacing:.15em;text-transform:uppercase;color:var(--ink-mid);display:block;margin-bottom:.35rem;}
.page-title{font-size:1.65rem;line-height:1.2;margin-bottom:.3rem;}
.page-sub{font-size:.8rem;color:var(--ink-dim);margin-bottom:1.75rem;line-height:1.6;}
.rule{border:none;border-top:1px solid var(--border);margin:1.5rem 0;}

/* â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
  font-family:var(--mono);font-size:.68rem;font-weight:500;letter-spacing:.08em;text-transform:uppercase;
  border:1.5px solid var(--border-dark);background:transparent;color:var(--ink-dim);
  padding:.45rem 1rem;border-radius:var(--r-sm);cursor:pointer;
  transition:all .16s;display:inline-flex;align-items:center;gap:.4rem;white-space:nowrap;
}
.btn:hover{border-color:var(--ink);color:var(--ink);background:var(--paper2);}
.btn:disabled{opacity:.35;cursor:not-allowed;pointer-events:none;}
.btn-gold{background:var(--gold);border-color:var(--gold);color:#fff;}
.btn-gold:hover{background:var(--gold-light);border-color:var(--gold-light);color:#fff;}
.btn-ink{background:var(--ink);border-color:var(--ink);color:var(--paper);}
.btn-ink:hover{background:#1e1e26;border-color:#1e1e26;color:var(--paper);}
.btn-ghost{border-color:transparent;color:var(--ink-mid);}
.btn-ghost:hover{border-color:var(--border);color:var(--ink);background:transparent;}
.btn-danger{border-color:rgba(192,57,43,.3);color:var(--red);}
.btn-danger:hover{background:var(--red);border-color:var(--red);color:#fff;}
.btn-sm{padding:.3rem .65rem;font-size:.6rem;}
.btn-for{border-color:rgba(30,122,74,.35);color:var(--green);}
.btn-for:hover,.btn-for.active{background:var(--green);border-color:var(--green);color:#fff;}
.btn-against{border-color:rgba(192,57,43,.3);color:var(--red);}
.btn-against:hover,.btn-against.active{background:var(--red);border-color:var(--red);color:#fff;}

/* â”€â”€â”€ Form elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field{display:flex;flex-direction:column;gap:.3rem;margin-bottom:.85rem;}
.field label{font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;color:var(--ink-mid);}
.fi{
  font-family:var(--mono);font-size:.85rem;font-weight:400;
  background:var(--paper);border:1.5px solid var(--border);
  border-radius:var(--r-sm);color:var(--ink);
  padding:.5rem .75rem;outline:none;transition:border-color .16s;width:100%;
}
.fi:focus{border-color:var(--gold);}
.fi::placeholder{color:var(--ink-mid);}
input[type=number].fi{-moz-appearance:textfield;}
input[type=number].fi::-webkit-inner-spin-button{display:none;}

/* â”€â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{
  background:var(--paper);border:1.5px solid var(--border);
  border-radius:var(--r);padding:1.35rem;
  box-shadow:var(--shadow);
}
.card+.card{margin-top:.75rem;}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.1rem;}
.card-title{font-family:var(--serif);font-size:1.05rem;}

/* â”€â”€â”€ Steps nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.step-nav{
  display:flex;align-items:center;gap:0;
  margin-bottom:2rem;
  border:1.5px solid var(--border);border-radius:var(--r);
  overflow:hidden;background:var(--paper2);
}
.step-pip{
  flex:1;padding:.5rem .5rem;text-align:center;
  font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--ink-mid);border-right:1px solid var(--border);
  position:relative;transition:all .2s;line-height:1.3;
}
.step-pip:last-child{border-right:none;}
.step-pip.done{color:var(--gold);background:rgba(184,145,58,.06);}
.step-pip.active{background:var(--ink);color:var(--gold-light);font-weight:500;}
.step-pip.done::after{content:'âœ“';display:block;font-size:.65rem;}

/* â”€â”€â”€ Thought row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.thought-row{
  display:flex;align-items:center;gap:.75rem;
  padding:.65rem .85rem;
  background:var(--paper2);border:1.5px solid var(--border);
  border-radius:var(--r-sm);margin-bottom:.5rem;
  transition:border-color .15s;
}
.thought-row:hover{border-color:var(--border-dark);}
.thought-name{flex:1;font-size:.88rem;color:var(--ink);}
.thought-weight{
  font-family:var(--serif);font-size:1.4rem;font-weight:700;
  color:var(--gold);min-width:2rem;text-align:center;
}
.thought-remove{
  width:24px;height:24px;border-radius:50%;background:none;border:1px solid transparent;
  color:var(--ink-mid);font-size:.8rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;flex-shrink:0;
}
.thought-remove:hover{border-color:var(--red);color:var(--red);}

/* â”€â”€â”€ Seat distributor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.seat-field{
  background:var(--paper2);border:1.5px solid var(--border);
  border-radius:var(--r);padding:1.1rem;margin-bottom:.85rem;
}
.seat-field-name{font-family:var(--serif);font-size:1rem;margin-bottom:.15rem;}
.seat-counter{font-size:.68rem;color:var(--ink-mid);margin-bottom:.85rem;}
.seat-counter span{font-family:var(--mono);font-weight:500;}
.seat-counter span.ok{color:var(--green);}
.seat-counter span.over{color:var(--red);}
.seat-row{display:flex;align-items:center;gap:.65rem;margin-bottom:.5rem;}
.seat-row:last-child{margin-bottom:0;}
.seat-thought-name{flex:1;font-size:.83rem;color:var(--ink-dim);}
.seat-stepper{display:flex;align-items:center;gap:.3rem;}
.seat-val{
  font-family:var(--serif);font-size:1.25rem;font-weight:700;
  color:var(--gold);min-width:1.6rem;text-align:center;
}
.s-btn{
  width:26px;height:26px;border-radius:var(--r-sm);
  background:var(--paper);border:1.5px solid var(--border);
  color:var(--ink-dim);font-size:.9rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .14s;flex-shrink:0;
}
.s-btn:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-pale);}
.s-btn:disabled{opacity:.3;cursor:not-allowed;}

/* â”€â”€â”€ Summary confirm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.summary-section{margin-bottom:1.25rem;}
.summary-label{font-size:.58rem;letter-spacing:.14em;text-transform:uppercase;color:var(--ink-mid);margin-bottom:.5rem;display:block;}
.summary-thought-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:.5rem .75rem;border-bottom:1px solid var(--border);
}
.summary-thought-row:last-child{border-bottom:none;}
.summary-field-block{
  background:var(--paper2);border:1.5px solid var(--border);
  border-radius:var(--r-sm);overflow:hidden;margin-bottom:.5rem;
}
.summary-field-header{
  padding:.45rem .75rem;background:var(--paper3);
  font-size:.72rem;font-family:var(--serif);font-style:italic;
  border-bottom:1px solid var(--border);
}
.summary-field-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:.42rem .75rem;border-bottom:1px solid var(--border);font-size:.82rem;
}
.summary-field-row:last-child{border-bottom:none;}
.seat-dot{
  display:inline-flex;gap:3px;
}
.seat-dot span{
  width:8px;height:8px;border-radius:50%;
  background:var(--gold);display:inline-block;
}
.seat-dot span.empty{background:var(--border);}

/* â”€â”€â”€ Parliament formed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.parliament-formed{
  text-align:center;padding:2.5rem 1rem;
}
.formed-icon{font-size:3rem;margin-bottom:1rem;display:block;}
.formed-title{font-family:var(--serif);font-size:2rem;margin-bottom:.5rem;}
.formed-sub{font-size:.82rem;color:var(--ink-dim);margin-bottom:2rem;line-height:1.7;}

/* â”€â”€â”€ Parliament status banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.parliament-status{
  background:var(--ink);color:var(--paper);
  border-radius:var(--r);padding:1.1rem 1.35rem;
  display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;
  margin-bottom:1.5rem;
}
.ps-left{}
.ps-label{font-size:.58rem;letter-spacing:.14em;text-transform:uppercase;color:rgba(255,255,255,.4);margin-bottom:.3rem;}
.ps-thoughts{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.5rem;}
.ps-thought-chip{
  font-size:.65rem;padding:.2rem .6rem;border-radius:99px;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);
  color:rgba(255,255,255,.7);
}
.ps-thought-chip .chip-w{color:var(--gold-light);margin-left:.3rem;font-family:var(--serif);}

/* â”€â”€â”€ Voting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.vote-initiate{
  text-align:center;padding:3rem 1rem;
}
.vote-session{animation:rise .2s ease;}
.vote-thought-card{
  display:flex;align-items:center;justify-content:space-between;gap:1rem;
  padding:.85rem 1.1rem;
  background:var(--paper2);border:1.5px solid var(--border);
  border-radius:var(--r-sm);margin-bottom:.55rem;
  transition:border-color .15s;
}
.vtc-left{display:flex;align-items:center;gap:.75rem;}
.vtc-name{font-size:.9rem;font-family:var(--serif);}
.vtc-weight{font-family:var(--serif);font-size:1.35rem;font-weight:700;color:var(--gold);}
.vtc-btns{display:flex;gap:.4rem;}

/* Results */
.result-banner{
  border-radius:var(--r);padding:1.35rem 1.5rem;margin-bottom:1rem;
  border:2px solid;
}
.result-banner.passed-t1{background:rgba(30,122,74,.07);border-color:rgba(30,122,74,.3);}
.result-banner.passed-t2{background:rgba(30,122,74,.12);border-color:rgba(30,122,74,.5);}
.result-banner.passed-t3{background:rgba(30,122,74,.18);border-color:var(--green);}
.result-banner.not-passed{background:var(--red-pale);border-color:rgba(192,57,43,.3);}
.result-verdict{font-family:var(--serif);font-size:1.5rem;margin-bottom:.25rem;}
.result-pct{font-size:.8rem;color:var(--ink-dim);}
.result-tier-badge{
  display:inline-block;font-size:.62rem;letter-spacing:.08em;text-transform:uppercase;
  padding:.25rem .7rem;border-radius:99px;margin-top:.5rem;
}
.tb-t1{background:rgba(30,122,74,.12);color:var(--green);border:1px solid rgba(30,122,74,.3);}
.tb-t2{background:rgba(30,122,74,.2);color:var(--green);border:1px solid rgba(30,122,74,.5);}
.tb-t3{background:rgba(184,145,58,.12);color:var(--gold);border:1px solid rgba(184,145,58,.35);}
.tb-np{background:var(--red-pale);color:var(--red);border:1px solid rgba(192,57,43,.25);}
.result-breakdown{margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border);}
.rb-row{display:flex;align-items:center;justify-content:space-between;padding:.35rem 0;font-size:.82rem;border-bottom:1px solid var(--border);}
.rb-row:last-child{border-bottom:none;}
.rb-name{color:var(--ink-dim);}
.rb-vote-for{color:var(--green);font-size:.62rem;letter-spacing:.08em;text-transform:uppercase;}
.rb-vote-ag{color:var(--red);font-size:.62rem;letter-spacing:.08em;text-transform:uppercase;}
.rb-w{font-family:var(--serif);font-weight:700;}
.validity-note{
  margin-top:.85rem;padding:.65rem .85rem;
  background:var(--paper2);border-radius:var(--r-sm);border:1px solid var(--border);
  font-size:.75rem;color:var(--ink-dim);line-height:1.65;
}

/* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast{
  position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(8px);
  background:var(--ink);color:var(--paper);
  border-radius:99px;padding:.55rem 1.25rem;font-size:.72rem;letter-spacing:.04em;
  opacity:0;transition:all .22s;pointer-events:none;z-index:999;white-space:nowrap;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* â”€â”€â”€ Empty / misc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.big-btn{
  width:100%;padding:1.1rem;font-size:.75rem;justify-content:center;
  border-radius:var(--r);letter-spacing:.1em;
}
.nav-row{display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-top:1.5rem;padding-top:1.25rem;border-top:1.5px solid var(--border);}
.badge-row{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.5rem;}
.badge{font-size:.62rem;letter-spacing:.06em;text-transform:uppercase;padding:.22rem .65rem;border-radius:99px;background:var(--paper2);border:1px solid var(--border);color:var(--ink-dim);}
.badge.active{background:var(--gold-pale);border-color:rgba(184,145,58,.4);color:var(--gold);}

@media(max-width:520px){
  main{padding:1.25rem 1rem;}
  header{padding:.8rem 1rem;}
  .tabs{padding:0 1rem;}
}
</style>
</head>
<body>

<header>
  <div class="logo">
    <h1>Parliament</h1>
    <div class="logo-sep"></div>
    <span class="logo-sub">Inner Discussion Group</span>
  </div>
  <span class="pwa-hint">Personal Â· Offline</span>
</header>

<nav class="tabs">
  <button class="tab-btn active" data-tab="session" onclick="switchTab('session')">This Session</button>
  <button class="tab-btn" data-tab="voting" onclick="switchTab('voting')">Voting</button>
</nav>

<main>
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SESSION TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-session" class="view active">
    <div id="session-content"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VOTING TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-voting" class="view">
    <div id="voting-content"></div>
  </div>
</main>

<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let P = null; // Parliament â€” null if not formed
// P shape: { thoughts:[{name,weight}], fields:[{name,seats:{[thoughtName]:n}}] }

let sessionStep = 0; // 0=home, 1=general, 2=fields, 3=seats, 4=confirm, 5=formed

// working state during formation
let draft = {
  thoughts: [],         // [{name, weight}]
  fieldNames: ['','',''],  // 3 specialised field names
  seats: {}             // { fieldName: { thoughtName: n } }
};

// voting working state
let vote = null;
// vote shape: { title, fields:Set, votes:{thoughtName:'for'|'against'|null} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function save(){localStorage.setItem('parl_v4',JSON.stringify({P,sessionStep,draft}));}
function load(){
  try{
    const raw=localStorage.getItem('parl_v4');
    if(raw){
      const d=JSON.parse(raw);
      P=d.P||null;
      sessionStep=d.sessionStep||0;
      draft=d.draft||{thoughts:[],fieldNames:['','',''],seats:{}};
    }
  }catch(e){}
  // ensure defaults
  if(!draft.thoughts) draft.thoughts=[];
  if(!draft.fieldNames||draft.fieldNames.length<3) draft.fieldNames=['','',''];
  if(!draft.seats) draft.seats={};
  // if formed, skip to formed step
  if(P) sessionStep=5;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
let _tt;
function toast(msg,dur=2200){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),dur);
}
function fmt(n){return typeof n==='number'&&!Number.isInteger(n)?n.toFixed(2).replace(/\.?0+$/,''):String(n);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentTab='session';
function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===tab));
  document.querySelectorAll('.view').forEach(v=>v.classList.toggle('active',v.id==='tab-'+tab));
  if(tab==='session') renderSession();
  if(tab==='voting') renderVoting();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SESSION RENDERER (step machine)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSession(){
  const el=document.getElementById('session-content');
  if(sessionStep===0) el.innerHTML=renderStep0();
  else if(sessionStep===1) el.innerHTML=renderStep1();
  else if(sessionStep===2) el.innerHTML=renderStep2();
  else if(sessionStep===3) el.innerHTML=renderStep3();
  else if(sessionStep===4) el.innerHTML=renderStep4();
  else if(sessionStep===5) el.innerHTML=renderStep5();
  attachListeners();
}

function stepPips(current){
  const steps=['Thoughts','Fields','Seats','Confirm'];
  return `<div class="step-nav">
    ${steps.map((s,i)=>{
      const si=i+1;
      const done=current>si;
      const active=current===si;
      return `<div class="step-pip${done?' done':active?' active':''}">
        ${s}${done?'':''}</div>`;
    }).join('')}
  </div>`;
}

/* Step 0: Home */
function renderStep0(){
  return `
    <span class="eyebrow">Your Inner Parliament</span>
    <h2 class="page-title">Welcome back.</h2>
    <p class="page-sub">Form your inner discussion group to begin deliberating decisions with intention. Your parliament holds your thoughts as parties, each with their own weight and voice.</p>
    <button class="btn btn-ink big-btn" onclick="goStep(1)">Form Your Inner Discussion Group</button>`;
}

/* Step 1: General weights */
function renderStep1(){
  const rows=draft.thoughts.map((t,i)=>`
    <div class="thought-row" id="tr-${i}">
      <span class="thought-name">${esc(t.name)}</span>
      <input type="number" class="fi" value="${t.weight}" min="0"
        style="width:70px;text-align:center;"
        oninput="draft.thoughts[${i}].weight=Math.max(0,parseInt(this.value)||0);save();"
        onchange="save();"/>
      <button class="thought-remove" onclick="removethought(${i})" title="Remove">âœ•</button>
    </div>`).join('');

  const canNext=draft.thoughts.length>=1&&draft.thoughts.every(t=>t.weight>=0);

  return `
    ${stepPips(1)}
    <span class="eyebrow">Step 1 of 4</span>
    <h2 class="page-title">Assign General Weight</h2>
    <p class="page-sub">Name your thoughts and assign each a general weight â€” how much influence does this part of you carry overall?</p>

    <div id="thought-list">${rows}</div>

    <div style="display:flex;align-items:center;gap:.65rem;margin-bottom:1.5rem;">
      <input class="fi" type="text" id="new-thought-in" placeholder="Name this thoughtâ€¦" style="flex:1;"
        onkeydown="if(event.key==='Enter')addThought();"/>
      <button class="btn btn-gold btn-sm" onclick="addThought()">+ Add</button>
    </div>

    <div class="nav-row">
      <button class="btn btn-ghost" onclick="goStep(0)">â† Back</button>
      <button class="btn btn-ink${canNext?'':''}" ${canNext?'':'disabled'} onclick="goStep(2)">Next â†’</button>
    </div>`;
}

/* Step 2: Field names */
function renderStep2(){
  const inputs=draft.fieldNames.map((f,i)=>`
    <div class="field">
      <label>Prioritised Field ${i+1}</label>
      <input class="fi" type="text" value="${esc(f)}" placeholder="e.g. Career, Relationships, Healthâ€¦"
        oninput="draft.fieldNames[${i}]=this.value.trim();save();updateStep2Btn();"
        />
    </div>`).join('');

  const canNext=draft.fieldNames.every(f=>f.trim().length>0);

  return `
    ${stepPips(2)}
    <span class="eyebrow">Step 2 of 4</span>
    <h2 class="page-title">Name Specialised Fields</h2>
    <p class="page-sub">Define three prioritised fields or issues that matter to your decisions. These give your parliament a specialised lens to weigh in on.</p>

    ${inputs}

    <div class="nav-row">
      <button class="btn btn-ghost" onclick="goStep(1)">â† Back</button>
      <button id="step2-next" class="btn btn-ink" ${canNext?'':'disabled'} onclick="initSeatsAndGoStep3()">Next â†’</button>
    </div>`;
}

function updateStep2Btn(){
  const btn=document.getElementById('step2-next');
  if(!btn) return;
  btn.disabled=!draft.fieldNames.every(f=>f.trim().length>0);
}

/* Step 3: Seat distribution */
function renderStep3(){
  const blocks=draft.fieldNames.map((fname,fi)=>{
    const seatMap=draft.seats[fname]||{};
    const totalAssigned=Object.values(seatMap).reduce((a,b)=>a+b,0);
    const remaining=3-totalAssigned;
    const rows=draft.thoughts.map(t=>{
      const assigned=seatMap[t.name]||0;
      return `<div class="seat-row">
        <span class="seat-thought-name">${esc(t.name)}</span>
        <div class="seat-stepper">
          <button class="s-btn" ${assigned<=0?'disabled':''} onclick="adjSeat('${esc(fname)}','${esc(t.name)}',-1)">âˆ’</button>
          <span class="seat-val">${assigned}</span>
          <button class="s-btn" ${remaining<=0&&assigned<3?'disabled':''} onclick="adjSeat('${esc(fname)}','${esc(t.name)}',1)">+</button>
        </div>
      </div>`;
    }).join('');

    const pips=Array.from({length:3},(_,k)=>
      `<span${k<totalAssigned?'':' class="empty"'}></span>`).join('');

    return `<div class="seat-field">
      <div class="seat-field-name">${esc(fname)}</div>
      <div class="seat-counter">
        <div class="seat-dot">${pips}</div>
        <span class="${remaining===0?'ok':remaining<0?'over':''}">
          ${totalAssigned}/3 seats assigned${remaining>0?` Â· ${remaining} remaining`:''}
        </span>
      </div>
      ${rows}
    </div>`;
  }).join('');

  const allDone=draft.fieldNames.every(fname=>{
    const s=draft.seats[fname]||{};
    return Object.values(s).reduce((a,b)=>a+b,0)===3;
  });

  return `
    ${stepPips(3)}
    <span class="eyebrow">Step 3 of 4</span>
    <h2 class="page-title">Distribute Seats</h2>
    <p class="page-sub">Each specialised field has <strong>3 seats</strong> to distribute among your thoughts. Assign all 3 to proceed.</p>

    ${blocks}

    <div class="nav-row">
      <button class="btn btn-ghost" onclick="goStep(2)">â† Back</button>
      <button class="btn btn-ink" ${allDone?'':'disabled'} onclick="goStep(4)">Review â†’</button>
    </div>`;
}

/* Step 4: Confirm */
function renderStep4(){
  const thoughtRows=draft.thoughts.map(t=>`
    <div class="summary-thought-row">
      <span>${esc(t.name)}</span>
      <span style="font-family:var(--serif);font-size:1.1rem;color:var(--gold);">${t.weight}</span>
    </div>`).join('');

  const fieldBlocks=draft.fieldNames.map(fname=>{
    const smap=draft.seats[fname]||{};
    const rows=Object.entries(smap).filter(([,v])=>v>0).map(([tname,seats])=>`
      <div class="summary-field-row">
        <span>${esc(tname)}</span>
        <span style="font-family:var(--serif);color:var(--gold);">${seats} seat${seats!==1?'s':''}</span>
      </div>`).join('');
    return `<div class="summary-field-block">
      <div class="summary-field-header">${esc(fname)}</div>
      ${rows}
    </div>`;
  }).join('');

  return `
    ${stepPips(4)}
    <span class="eyebrow">Step 4 of 4</span>
    <h2 class="page-title">Confirm Formation</h2>
    <p class="page-sub">Review your parliament's composition before forming. Once formed, you'll need to dissolve the group to make changes.</p>

    <div class="card" style="margin-bottom:1rem;">
      <div class="card-header"><div class="card-title">Thoughts & General Weights</div></div>
      <div style="border:1px solid var(--border);border-radius:var(--r-sm);overflow:hidden;">
        ${thoughtRows}
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">Specialised Fields & Seats</div></div>
      ${fieldBlocks}
    </div>

    <div class="nav-row">
      <button class="btn btn-ghost" onclick="goStep(3)">â† Back</button>
      <button class="btn btn-gold" onclick="formParliament()">ğŸ› Form Parliament</button>
    </div>`;
}

/* Step 5: Formed */
function renderStep5(){
  if(!P) return renderStep0();

  const thoughtChips=P.thoughts.map(t=>`
    <span class="ps-thought-chip">${esc(t.name)}<span class="chip-w">${t.weight}</span></span>`).join('');

  const fieldSummary=P.fields.map(f=>{
    const rows=Object.entries(f.seats).filter(([,v])=>v>0).map(([tname,s])=>
      `<span style="font-size:.75rem;color:var(--ink-dim);">${esc(tname)} <span style="color:var(--gold);font-family:var(--serif);">${s}</span></span>`
    ).join('<span style="color:var(--border-dark);margin:0 .3rem;">Â·</span>');
    return `<div style="margin-bottom:.6rem;">
      <div style="font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;color:var(--ink-mid);margin-bottom:.25rem;">${esc(f.name)}</div>
      <div style="display:flex;flex-wrap:wrap;gap:.35rem;align-items:center;">${rows}</div>
    </div>`;
  }).join('');

  return `
    <div class="parliament-status">
      <div class="ps-left">
        <div class="ps-label">Parliament in Session</div>
        <div style="font-family:var(--serif);font-size:1.05rem;color:var(--paper);">
          ${P.thoughts.length} thought${P.thoughts.length!==1?'s':''} Â· ${P.fields.length} fields
        </div>
        <div class="ps-thoughts">${thoughtChips}</div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="showDissolveConfirm()">Dissolve</button>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">General Weights</div></div>
      ${P.thoughts.map(t=>`
        <div class="summary-thought-row">
          <span>${esc(t.name)}</span>
          <span style="font-family:var(--serif);font-size:1.1rem;color:var(--gold);">${t.weight}</span>
        </div>`).join('')}
    </div>

    <div class="card" style="margin-top:.75rem;">
      <div class="card-header"><div class="card-title">Specialised Fields</div></div>
      ${fieldSummary}
    </div>

    <div id="dissolve-confirm" style="display:none;margin-top:1rem;padding:1rem 1.1rem;background:var(--red-pale);border:1.5px solid rgba(192,57,43,.3);border-radius:var(--r);">
      <p style="font-size:.82rem;color:var(--ink);margin-bottom:.85rem;">Are you sure? This will clear all weights and seat assignments.</p>
      <div style="display:flex;gap:.5rem;">
        <button class="btn btn-danger btn-sm" onclick="dissolve()">Yes, Dissolve</button>
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('dissolve-confirm').style.display='none'">Cancel</button>
      </div>
    </div>

    <div style="margin-top:1.5rem;text-align:center;">
      <p style="font-size:.75rem;color:var(--ink-mid);margin-bottom:1rem;">Parliament is ready. Head to the Voting tab to deliberate.</p>
      <button class="btn btn-gold" onclick="switchTab('voting')">Go to Voting â†’</button>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SESSION ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goStep(n){
  sessionStep=n;
  save();
  renderSession();
  window.scrollTo({top:0,behavior:'smooth'});
}

function addThought(){
  const inp=document.getElementById('new-thought-in');
  if(!inp) return;
  const name=inp.value.trim();
  if(!name){inp.focus();return;}
  if(draft.thoughts.find(t=>t.name.toLowerCase()===name.toLowerCase())){
    toast('A thought with that name already exists.');return;
  }
  draft.thoughts.push({name,weight:1});
  inp.value='';
  save();
  renderSession();
  document.getElementById('new-thought-in')?.focus();
}

function removethought(i){
  const name=draft.thoughts[i]?.name;
  draft.thoughts.splice(i,1);
  // remove from seats
  if(name){
    Object.keys(draft.seats).forEach(f=>{
      delete draft.seats[f][name];
    });
  }
  save();renderSession();
}

function initSeatsAndGoStep3(){
  // ensure seat maps exist for all fields, with all thoughts
  draft.fieldNames.forEach(fname=>{
    if(!draft.seats[fname]) draft.seats[fname]={};
    // add new thoughts with 0 seats
    draft.thoughts.forEach(t=>{
      if(draft.seats[fname][t.name]===undefined) draft.seats[fname][t.name]=0;
    });
    // remove old thoughts no longer present
    const tnames=new Set(draft.thoughts.map(t=>t.name));
    Object.keys(draft.seats[fname]).forEach(k=>{if(!tnames.has(k)) delete draft.seats[fname][k];});
  });
  // clean seats for removed/renamed fields
  const fset=new Set(draft.fieldNames);
  Object.keys(draft.seats).forEach(k=>{if(!fset.has(k)) delete draft.seats[k];});
  goStep(3);
}

function adjSeat(fname,tname,delta){
  if(!draft.seats[fname]) draft.seats[fname]={};
  const cur=draft.seats[fname][tname]||0;
  const total=Object.values(draft.seats[fname]).reduce((a,b)=>a+b,0);
  if(delta>0&&total>=3) return; // max 3 seats per field
  const nv=Math.max(0,cur+delta);
  draft.seats[fname][tname]=nv;
  save();renderSession();
}

function formParliament(){
  P={
    thoughts:draft.thoughts.map(t=>({...t})),
    fields:draft.fieldNames.map(fname=>({
      name:fname,
      seats:{...draft.seats[fname]}
    }))
  };
  sessionStep=5;
  // reset draft
  draft={thoughts:[],fieldNames:['','',''],seats:{}};
  save();renderSession();
  toast('Parliament formed! ğŸ‰',3000);
}

function showDissolveConfirm(){
  const el=document.getElementById('dissolve-confirm');
  if(el) el.style.display='block';
}

function dissolve(){
  P=null;sessionStep=0;
  draft={thoughts:[],fieldNames:['','',''],seats:{}};
  vote=null;
  save();renderSession();renderVoting();
  toast('Parliament dissolved.');
}

function attachListeners(){
  // nothing extra needed â€” using inline handlers
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOTING RENDERER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderVoting(){
  const el=document.getElementById('voting-content');
  if(!P){
    el.innerHTML=`
      <div class="vote-initiate">
        <span class="eyebrow" style="justify-content:center;display:block;">Voting</span>
        <h2 class="page-title" style="margin-bottom:.5rem;">No Parliament in Session</h2>
        <p style="font-size:.82rem;color:var(--ink-dim);margin-bottom:1.5rem;">Form your inner discussion group first before initiating a vote.</p>
        <button class="btn btn-gold" onclick="switchTab('session')">Go to This Session â†’</button>
      </div>`;
    return;
  }

  if(!vote){
    el.innerHTML=`
      <div class="vote-initiate">
        <span class="eyebrow" style="display:block;text-align:center;">Parliament Ready</span>
        <h2 class="page-title" style="margin-bottom:.5rem;">Cast a Vote</h2>
        <p style="font-size:.82rem;color:var(--ink-dim);margin-bottom:1.5rem;">Initiate a vote to deliberate on a decision with your inner parliament.</p>
        <button class="btn btn-gold big-btn" onclick="initVote()">Initiate a Vote</button>
      </div>`;
    return;
  }

  // vote in progress
  el.innerHTML=renderVoteSession();
}

function initVote(){
  vote={title:'',fields:new Set(),votes:{}};
  P.thoughts.forEach(t=>vote.votes[t.name]=null);
  renderVoting();
}

function renderVoteSession(){
  // Step: title
  if(!vote._step) vote._step=1;

  if(vote._step===1) return renderVoteStep1();
  if(vote._step===2) return renderVoteStep2();
  if(vote._step===3) return renderVoteStep3();
  if(vote._step===4) return renderVoteResult();
  return '';
}

/* Vote step 1: title */
function renderVoteStep1(){
  return `<div class="vote-session">
    <span class="eyebrow">Vote â€” Step 1 of 3</span>
    <h2 class="page-title">What is being decided?</h2>
    <p class="page-sub">Give this deliberation a clear title.</p>
    <div class="field">
      <label>Decision Title</label>
      <input class="fi" type="text" id="vote-title-in" value="${esc(vote.title)}"
        placeholder="e.g. Should I take the job offer?"
        oninput="vote.title=this.value;updateVoteStep1Btn();"
        onkeydown="if(event.key==='Enter'&&vote.title.trim()) goVoteStep(2);"/>
    </div>
    <div class="nav-row">
      <button class="btn btn-ghost" onclick="cancelVote()">âœ• Cancel</button>
      <button class="btn btn-ink" id="vote-next-1" onclick="if(vote.title.trim())goVoteStep(2);"
        ${vote.title.trim()?'':'disabled'}>Next â†’</button>
    </div>
  </div>`;
}

/* Vote step 2: select fields */
function renderVoteStep2(){
  const fieldPills=P.fields.map(f=>{
    const sel=vote.fields.has(f.name);
    return `<span class="badge${sel?' active':''}" style="cursor:pointer;font-size:.72rem;padding:.3rem .85rem;"
      onclick="toggleVoteField('${esc(f.name)}')">${esc(f.name)}</span>`;
  }).join('');

  return `<div class="vote-session">
    <span class="eyebrow">Vote â€” Step 2 of 3</span>
    <h2 class="page-title" style="font-size:1.3rem;">${esc(vote.title)}</h2>
    <p class="page-sub">Which specialised fields does this decision touch? Leave none selected to use general weights only.</p>

    <div class="badge-row">${fieldPills}</div>

    ${vote.fields.size>0?`
      <div style="padding:.6rem .85rem;background:var(--paper2);border-radius:var(--r-sm);border:1px solid var(--border);font-size:.75rem;color:var(--ink-dim);margin-bottom:1rem;">
        Selected: <strong style="color:var(--ink);">${[...vote.fields].map(f=>`<em>${esc(f)}</em>`).join(', ')}</strong>
      </div>`:''}

    <div class="nav-row">
      <button class="btn btn-ghost" onclick="goVoteStep(1)">â† Back</button>
      <button class="btn btn-ink" onclick="goVoteStep(3)">Next â†’</button>
    </div>
  </div>`;
}

/* Vote step 3: cast votes */
function renderVoteStep3(){
  // compute effective weights
  const weights=computeEffectiveWeights();

  const rows=P.thoughts.map(t=>{
    const v=vote.votes[t.name];
    const w=weights[t.name]||0;
    return `<div class="vote-thought-card">
      <div class="vtc-left">
        <div>
          <div class="vtc-name">${esc(t.name)}</div>
          <div style="font-size:.62rem;color:var(--ink-mid);margin-top:.1rem;">
            Weight: <span style="font-family:var(--serif);color:var(--gold);">${fmt(w)}</span>
          </div>
        </div>
      </div>
      <div class="vtc-btns">
        <button class="btn btn-for btn-sm${v==='for'?' active':''}" onclick="castVote('${esc(t.name)}','for')">âœ“ For</button>
        <button class="btn btn-against btn-sm${v==='against'?' active':''}" onclick="castVote('${esc(t.name)}','against')">âœ— Against</button>
      </div>
    </div>`;
  }).join('');

  const allVoted=P.thoughts.every(t=>vote.votes[t.name]!==null);

  return `<div class="vote-session">
    <span class="eyebrow">Vote â€” Step 3 of 3</span>
    <h2 class="page-title" style="font-size:1.3rem;">${esc(vote.title)}</h2>
    ${vote.fields.size>0?`<p style="font-size:.75rem;color:var(--ink-dim);margin-bottom:1.25rem;">Fields: ${[...vote.fields].map(f=>`<em>${esc(f)}</em>`).join(', ')}</p>`:'<p style="font-size:.75rem;color:var(--ink-mid);margin-bottom:1.25rem;">Using general weights only.</p>'}

    ${rows}

    <div class="nav-row">
      <button class="btn btn-ghost" onclick="goVoteStep(2)">â† Back</button>
      <button class="btn btn-gold" ${allVoted?'':'disabled'} onclick="goVoteStep(4)">Calculate Result â†’</button>
    </div>
  </div>`;
}

/* Vote step 4: result */
function renderVoteResult(){
  const weights=computeEffectiveWeights();
  let forWeight=0, againstWeight=0;

  P.thoughts.forEach(t=>{
    const w=weights[t.name]||0;
    if(vote.votes[t.name]==='for') forWeight+=w;
    else againstWeight+=w;
  });

  const total=forWeight+againstWeight;
  const forPct=total===0?0:(forWeight/total)*100;
  const threshold=200/3; // 66.666...

  let tier,tierClass,tBadgeClass,validity;
  if(forPct<threshold){
    tier='Not Passed';tierClass='not-passed';tBadgeClass='tb-np';
    validity='The decision does not have the support of Â²â„â‚ƒ of the parliament.';
  } else if(forPct<75){
    tier='Tier 1 â€” Passed';tierClass='passed-t1';tBadgeClass='tb-t1';
    validity='Effective for no more than <strong>7 days</strong>.';
  } else if(forPct<100){
    tier='Tier 2 â€” Passed';tierClass='passed-t2';tBadgeClass='tb-t2';
    validity='Effective for no more than <strong>30 days</strong>.';
  } else {
    tier='Tier 3 â€” Passed';tierClass='passed-t3';tBadgeClass='tb-t3';
    validity='Effective up to <strong>30 days</strong>, extendable to <strong>60 days</strong>.';
  }

  const breakdown=P.thoughts.map(t=>{
    const w=weights[t.name]||0;
    const v=vote.votes[t.name];
    return `<div class="rb-row">
      <span class="rb-name">${esc(t.name)}</span>
      <span class="${v==='for'?'rb-vote-for':'rb-vote-ag'}">${v==='for'?'âœ“ For':'âœ— Against'}</span>
      <span class="rb-w" style="color:var(--gold);">${fmt(w)}</span>
    </div>`;
  }).join('');

  const calcNote=vote.fields.size>0?`
    <div style="font-size:.7rem;color:var(--ink-mid);margin-top:.85rem;padding:.6rem .8rem;background:var(--paper2);border-radius:var(--r-sm);border:1px solid var(--border);line-height:1.7;">
      <strong>Weight formula:</strong> General + (sum of seats across selected fields Ã· number of fields)<br/>
      ${P.thoughts.map(t=>{
        const selectedFields=P.fields.filter(f=>vote.fields.has(f.name));
        const totalSeats=selectedFields.reduce((acc,f)=>acc+(f.seats[t.name]||0),0);
        const n=selectedFields.length;
        const effective=t.weight+totalSeats/n;
        return `<span style="color:var(--ink);">${esc(t.name)}</span>: ${t.weight} + ${totalSeats}/${n} = <strong style="color:var(--gold);">${fmt(effective)}</strong>`;
      }).join(' &nbsp;|&nbsp; ')}
    </div>`:'';

  return `<div class="vote-session">
    <span class="eyebrow">Result</span>
    <h2 class="page-title" style="font-size:1.3rem;margin-bottom:1rem;">${esc(vote.title)}</h2>

    <div class="result-banner ${tierClass}">
      <div class="result-verdict">${tier}</div>
      <div class="result-pct">${Math.round(forPct*10)/10}% in favour Â· ${fmt(forWeight)} of ${fmt(total)} seats</div>
      <span class="result-tier-badge ${tBadgeClass}">${tier}</span>
      <div class="validity-note" style="margin-top:.85rem;">${validity}</div>
    </div>

    <div class="result-breakdown">
      <span class="summary-label">Vote Breakdown</span>
      ${breakdown}
    </div>

    ${calcNote}

    <div class="nav-row" style="margin-top:1.5rem;">
      <button class="btn btn-ghost" onclick="goVoteStep(3)">â† Revote</button>
      <button class="btn btn-ink" onclick="resetVote()">New Vote</button>
    </div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOTING ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateVoteStep1Btn(){
  const btn=document.getElementById('vote-next-1');
  if(!btn) return;
  btn.disabled=!vote.title.trim();
}

function computeEffectiveWeights(){
  const w={};
  if(!P) return w;
  const selectedFields=vote.fields.size>0
    ? P.fields.filter(f=>vote.fields.has(f.name))
    : [];
  P.thoughts.forEach(t=>{
    if(selectedFields.length===0){
      w[t.name]=t.weight;
    } else {
      // avg of this thought's seats across each selected field
      const totalSeats=selectedFields.reduce((acc,f)=>acc+(f.seats[t.name]||0),0);
      const avgSeats=totalSeats/selectedFields.length;
      w[t.name]=t.weight+avgSeats;
    }
  });
  return w;
}

function toggleVoteField(fname){
  if(vote.fields.has(fname)) vote.fields.delete(fname);
  else vote.fields.add(fname);
  renderVoting();
}

function castVote(tname,v){
  vote.votes[tname]=v;
  renderVoting();
}

function goVoteStep(n){
  if(n===1&&vote._step===1){
    // sync title from input
    const inp=document.getElementById('vote-title-in');
    if(inp) vote.title=inp.value;
  }
  vote._step=n;
  renderVoting();
  window.scrollTo({top:0,behavior:'smooth'});
}

function cancelVote(){
  vote=null;renderVoting();
}
function resetVote(){
  vote=null;renderVoting();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
load();
renderSession();
renderVoting();
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>
